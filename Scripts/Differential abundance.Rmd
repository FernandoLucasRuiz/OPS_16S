---
title: "Differential abundance"
author: "Fernando Lucas Ruiz (fernando.lucas@um.es)"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
    highlight: kate
    number_sections: true
    theme: spacelab
    toc: true
    toc_float: true
    code_folding: "hide"
  pdf_document:
    toc: true
subtitle: Cirugía digestiva, endocrina y trasplante de órganos abdominales (IMIB)
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F)
```

```{r, warning=FALSE, message=FALSE}
source("../Librerias.R")
source("../utils.R")

covs <- readRDS("../../RDSs/paper/covs.RDS")
tse_lp <- readRDS("../../RDSs/paper/tse_lp.RDS")
tse_bilis <- readRDS("../../RDSs/paper/tse_bilis.RDS")
tse_stool <- readRDS("../../RDSs/paper/tse_stool.RDS")
tse_higado_sra <- readRDS("../../RDSs/paper/tse_higado_sra.RDS")
tse_bilis_sra <- readRDS("../../RDSs/paper/tse_bilis_sra.RDS")
tse_bilis_sra2 <- readRDS("../../RDSs/paper/tse_bilis_sra2.RDS")
tse_testset <- readRDS("../../RDSs/paper/tse_testset.RDS")

```

```{r}
sa <- colData(tse_lp) |> as.data.frame()
write_excel_csv2(sa, "/Users/fernandolucasruiz/Desktop/cov.csv")
```


# Cargar muestras

## Renombrar Phylum

```{r}
lp_nombres <- rownames(assay(agglomerateByRank(tse_lp, rank = "Phylum")))
sra_nombres_higado <- rownames(assay(agglomerateByRank(tse_higado_sra, rank = "Phylum")))
bilis_nombres <- rownames(assay(agglomerateByRank(tse_bilis, rank = "Phylum")))
stool_nombres <- rownames(assay(agglomerateByRank(tse_stool, rank = "Phylum")))
sra_nombres_bilis <- rownames(assay(agglomerateByRank(tse_bilis_sra, rank = "Phylum")))
sra_nombres_bilis2 <- rownames(assay(agglomerateByRank(tse_bilis_sra2, rank = "Phylum")))
testset_nombres <- rownames(assay(agglomerateByRank(tse_testset, rank = "Phylum")))


setdiff(c(lp_nombres, bilis_nombres, testset_nombres), c(sra_nombres_higado, stool_nombres, sra_nombres_bilis, sra_nombres_bilis2))
cat("\n")
setdiff(c(sra_nombres_higado, stool_nombres, sra_nombres_bilis, sra_nombres_bilis2), c(lp_nombres, bilis_nombres, testset_nombres))

correspondencia_nombres <- c("Acidobacteriota" = "Acidobacteria",
                             "Actinobacteriota" = "Actinobacteria",
                             "Bacteroidota" = "Bacteroidetes",
                             "Gemmatimonadota" = "Gemmatimonadetes",
                             "Nitrospirota" = "Nitrospirae"
                             )

sra_nombres_higado <- ifelse(sra_nombres_higado %in% names(correspondencia_nombres), 
                      correspondencia_nombres[sra_nombres_higado], 
                      sra_nombres_higado)
stool_nombres <- ifelse(stool_nombres %in% names(correspondencia_nombres), 
                      correspondencia_nombres[stool_nombres], 
                      stool_nombres)
sra_nombres_bilis <- ifelse(sra_nombres_bilis %in% names(correspondencia_nombres), 
                      correspondencia_nombres[sra_nombres_bilis], 
                      sra_nombres_bilis)
sra_nombres_bilis2 <- ifelse(sra_nombres_bilis2 %in% names(correspondencia_nombres), 
                      correspondencia_nombres[sra_nombres_bilis2], 
                      sra_nombres_bilis2)

cat("\n")
setdiff(c(lp_nombres, bilis_nombres, testset_nombres), c(sra_nombres_higado, stool_nombres, sra_nombres_bilis, sra_nombres_bilis2))
cat("\n")
setdiff(c(sra_nombres_higado, stool_nombres, sra_nombres_bilis, sra_nombres_bilis2), c(lp_nombres, bilis_nombres, testset_nombres))

rowData(tse_higado_sra)$Phylum <- ifelse(rowData(tse_higado_sra)$Phylum %in% names(correspondencia_nombres),
                      correspondencia_nombres[rowData(tse_higado_sra)$Phylum],
                      rowData(tse_higado_sra)$Phylum)

rowData(tse_stool)$Phylum <- ifelse(rowData(tse_stool)$Phylum %in% names(correspondencia_nombres),
                      correspondencia_nombres[rowData(tse_stool)$Phylum],
                      rowData(tse_stool)$Phylum)

rowData(tse_bilis_sra)$Phylum <- ifelse(rowData(tse_bilis_sra)$Phylum %in% names(correspondencia_nombres),
                      correspondencia_nombres[rowData(tse_bilis_sra)$Phylum],
                      rowData(tse_bilis_sra)$Phylum)

rowData(tse_bilis_sra2)$Phylum <- ifelse(rowData(tse_bilis_sra2)$Phylum %in% names(correspondencia_nombres),
                      correspondencia_nombres[rowData(tse_bilis_sra2)$Phylum],
                      rowData(tse_bilis_sra2)$Phylum)

```

## Renombrar Class

```{r}
lp_nombres <- rownames(assay(agglomerateByRank(tse_lp, rank = "Class")))
sra_nombres_higado <- rownames(assay(agglomerateByRank(tse_higado_sra, rank = "Class")))
bilis_nombres <- rownames(assay(agglomerateByRank(tse_bilis, rank = "Class")))
stool_nombres <- rownames(assay(agglomerateByRank(tse_stool, rank = "Class")))
sra_nombres_bilis <- rownames(assay(agglomerateByRank(tse_bilis_sra, rank = "Class")))
sra_nombres_bilis2 <- rownames(assay(agglomerateByRank(tse_bilis_sra2, rank = "Class")))


setdiff(c(lp_nombres, bilis_nombres, testset_nombres), c(sra_nombres_higado, stool_nombres, sra_nombres_bilis, sra_nombres_bilis2))
cat("\n")
setdiff(c(sra_nombres_higado, stool_nombres, sra_nombres_bilis, sra_nombres_bilis2), c(lp_nombres, bilis_nombres, testset_nombres))

correspondencia_nombres <- c("Acidobacteriota" = "Acidobacteria",
                             "Actinobacteriota" = "Actinobacteria",
                             "Bacteroidota" = "Bacteroidetes",
                             "Gemmatimonadota" = "Gemmatimonadetes",
                             "Nitrospirota" = "Nitrospirae"
                             )

sra_nombres_higado <- ifelse(sra_nombres_higado %in% names(correspondencia_nombres), 
                      correspondencia_nombres[sra_nombres_higado], 
                      sra_nombres_higado)
stool_nombres <- ifelse(stool_nombres %in% names(correspondencia_nombres), 
                      correspondencia_nombres[stool_nombres], 
                      stool_nombres)
sra_nombres_bilis <- ifelse(sra_nombres_bilis %in% names(correspondencia_nombres), 
                      correspondencia_nombres[sra_nombres_bilis], 
                      sra_nombres_bilis)
sra_nombres_bilis2 <- ifelse(sra_nombres_bilis2 %in% names(correspondencia_nombres), 
                      correspondencia_nombres[sra_nombres_bilis2], 
                      sra_nombres_bilis2)

cat("\n")
setdiff(c(lp_nombres, bilis_nombres, testset_nombres), c(sra_nombres_higado, stool_nombres, sra_nombres_bilis, sra_nombres_bilis2))
cat("\n")
setdiff(c(sra_nombres_higado, stool_nombres, sra_nombres_bilis, sra_nombres_bilis2), c(lp_nombres, bilis_nombres, testset_nombres))

rowData(tse_higado_sra)$Class <- ifelse(rowData(tse_higado_sra)$Class %in% names(correspondencia_nombres),
                      correspondencia_nombres[rowData(tse_higado_sra)$Class],
                      rowData(tse_higado_sra)$Class)

rowData(tse_stool)$Class <- ifelse(rowData(tse_stool)$Class %in% names(correspondencia_nombres),
                      correspondencia_nombres[rowData(tse_stool)$Class],
                      rowData(tse_stool)$Class)

rowData(tse_bilis_sra)$Class <- ifelse(rowData(tse_bilis_sra)$Class %in% names(correspondencia_nombres),
                      correspondencia_nombres[rowData(tse_bilis_sra)$Class],
                      rowData(tse_bilis_sra)$Class)

rowData(tse_bilis_sra2)$Class <- ifelse(rowData(tse_bilis_sra2)$Class %in% names(correspondencia_nombres),
                      correspondencia_nombres[rowData(tse_bilis_sra2)$Class],
                      rowData(tse_bilis_sra2)$Class)

```

"‘standardize’ Standardize(or ‘z-score’) transformation scales data to zero mean and unit variance. This is used to bring features (or samples) to more comparable levels in terms of mean and scale of the values. This can enhance visualization and interpretation of the data"

```{r}
tse_lp <- transformAssay(tse_lp, assay.type = "counts", method = "relabundance")
tse_lp <- transformAssay(tse_lp, assay.type = "counts", method = "standardize")
tse_lp <- transformAssay(tse_lp, assay.type = "relabundance", method = "clr", pseudocount = TRUE)

tse_higado_sra <- transformAssay(tse_higado_sra, assay.type = "counts", method = "relabundance")
tse_higado_sra <- transformAssay(tse_higado_sra, assay.type = "counts", method = "standardize")
tse_higado_sra <- transformAssay(tse_higado_sra, assay.type = "relabundance", method = "clr", pseudocount = TRUE)

tse_bilis <- transformAssay(tse_bilis, assay.type = "counts", method = "relabundance")
tse_bilis <- transformAssay(tse_bilis, assay.type = "counts", method = "standardize")
tse_bilis <- transformAssay(tse_bilis, assay.type = "relabundance", method = "clr", pseudocount = TRUE)

tse_bilis_sra <- transformAssay(tse_bilis_sra, assay.type = "counts", method = "relabundance")
tse_bilis_sra <- transformAssay(tse_bilis_sra, assay.type = "counts", method = "standardize")
tse_bilis_sra <- transformAssay(tse_bilis_sra, assay.type = "relabundance", method = "clr", pseudocount = TRUE)

tse_bilis_sra2 <- transformAssay(tse_bilis_sra2, assay.type = "counts", method = "relabundance")
tse_bilis_sra2 <- transformAssay(tse_bilis_sra2, assay.type = "counts", method = "standardize")
tse_bilis_sra2 <- transformAssay(tse_bilis_sra2, assay.type = "relabundance", method = "clr", pseudocount = TRUE)

tse_testset <- transformAssay(tse_testset, assay.type = "counts", method = "relabundance")
tse_testset <- transformAssay(tse_testset, assay.type = "counts", method = "standardize")
tse_testset <- transformAssay(tse_testset, assay.type = "relabundance", method = "clr", pseudocount = TRUE)

```

# Community composition

## Relative abundance

```{r, fig.width=8, fig.height= 5}
abundancias_phylum <- abundancias_relativas_totales(list(OPS = tse_lp, 
                                                  Bilis = tse_bilis,
                                                  'Liver SRP377201' = tse_higado_sra,
                                                  'Stool CMD' = tse_stool,
                                                  'Bilis SRP499252' = tse_bilis_sra2),
                                             ranking = "Phylum",
                                             top = 5)


abundancias_phylum <- abundancias_phylum %>%
    group_by(Taxon) %>%
    mutate(order_TSE_lp = ifelse(TSE == "OPS", Relative_Abundance, NA)) %>%
    arrange(desc(order_TSE_lp)) %>%
    ungroup() %>%
    mutate(taxa_sub = factor(taxa_sub, levels = c(unique(taxa_sub[taxa_sub != "Other"]), "Other")),
           TSE = factor(TSE, levels = c("OPS", 
                                        "Bilis", 
                                        "Bilis SRP499252", 
                                        "Liver SRP377201",  
                                        "Stool CMD")))

plotear_abundancia_relativa(abundancias_phylum, "Phylum")
```

```{r, fig.width=8, fig.height= 5}
abundancias_phylum_testset <- abundancias_relativas_totales(list(OPS = tse_lp, 
                                                  validation_cohort = tse_testset),
                                             ranking = "Phylum",
                                             top = 5)


abundancias_phylum_testset <- abundancias_phylum_testset %>%
    group_by(Taxon) %>%
    mutate(order_TSE_lp = ifelse(TSE == "OPS", Relative_Abundance, NA)) %>%
    arrange(desc(order_TSE_lp)) %>%
    ungroup() %>%
    mutate(taxa_sub = factor(taxa_sub, levels = c(unique(taxa_sub[taxa_sub != "Other"]), "Other")),
           TSE = factor(TSE, levels = c("OPS", 
                                        "validation_cohort")))

plotear_abundancia_relativa(abundancias_phylum_testset, "Phylum")
```

```{r, fig.width=10, fig.height=5}
abundancias_class <- abundancias_relativas_totales(list(OPS = tse_lp, 
                                                  Bilis = tse_bilis,
                                                  'Liver SRP377201' = tse_higado_sra,
                                                  'Stool CMD' = tse_stool,
                                                  'Bilis SRP499252' = tse_bilis_sra2),
                                             ranking = "Class",
                                             top = 5)


abundancias_class <- abundancias_class %>%
    group_by(Taxon) %>%
    mutate(order_TSE_lp = ifelse(TSE == "OPS", Relative_Abundance, NA)) %>%
    arrange(desc(order_TSE_lp)) %>%
    ungroup() %>%
    mutate(taxa_sub = factor(taxa_sub, levels = c(unique(taxa_sub[taxa_sub != "Other"]), "Other")),
           TSE = factor(TSE, levels = c("OPS", 
                                        "Bilis", 
                                        "Bilis SRP499252", 
                                        "Liver SRP377201",  
                                        "Stool CMD")))

plotear_abundancia_relativa(abundancias_class, "Class")
```

## Alpha diversity

```{r}
index <-  c("coverage_diversity", "fisher_diversity", "faith_diversity",
    "gini_simpson_diversity", "inverse_simpson_diversity",
    "log_modulo_skewness_diversity", "shannon_diversity", "absolute_dominance",
    "dbp_dominance", "core_abundance_dominance", "gini_dominance", "dmn_dominance",
    "relative_dominance", "simpson_lambda_dominance", "camargo_evenness",
    "pielou_evenness", "simpson_evenness", "evar_evenness", "bulla_evenness",
    "ace_richness", "chao1_richness", "hill_richness", "observed_richness")

index <- index[!index %in% c("fisher_diversity", "ace_richness", "chao1_richness", "faith_diversity")]

tse_lp <- addAlpha(
    tse_lp, assay.type = "relabundance", index = index, name = index)
```

```{r, fig.height=14, fig.width=10}
plots <- list()
variables_salida <- c("Survival", "AR", "AHT", "Biliary_complications")

for (j in variables_salida) {
    for (i in index){
        df <- colData(tse_lp) |> as.data.frame()
        
        
        p <- ggboxplot(df, x=j, y = i, fill = j, width=0.2) +
            geom_violin(fill = "gray", alpha= 0.2) +
            stat_compare_means(label = "p.format", label.x.npc = 0.5, label.y = 4.75) +
            scale_fill_manual(aes_string(x=j, y = i), values = c("#87CEFA", "#FA8072")) +
            scale_y_continuous(limits = c(min(df[[i]]), max(df[[i]]) * 1.2)) +
            guides(fill = "none")+ 
            theme_minimal()
        
        plots[[j]][[i]] <- p
        
    }
    
}

plots_alpha <- plots

# 
# do.call(grid.arrange, c(plots$Survival, ncol = 4))
# do.call(grid.arrange, c(plots$AR, ncol = 4))
# do.call(grid.arrange, c(plots$AHT, ncol = 4))
# do.call(grid.arrange, c(plots$Biliary_complications, ncol = 4))
```

```{r, fig.height=7, fig.width=10}

grid.arrange(plots$Survival$shannon_diversity, 
             plots$AR$shannon_diversity,
             plots$AHT$shannon_diversity,
             plots$Biliary_complications$shannon_diversity)
 


```

## Correlaciones con covariables

```{r, warning=FALSE}
# Calculate diversity measures
index <- c( "AR", "AHT", "Biliary_complications", "Survival")

tse <- tse_lp
colData(tse)$AR <- as.numeric(colData(tse)$AR) -1
colData(tse)$AHT <- as.numeric(colData(tse)$AHT) -1
colData(tse)$Biliary_complications <- as.numeric(colData(tse)$Biliary_complications) -1
colData(tse)$Survival <- as.numeric(colData(tse)$Survival) -1

# Get correlation results
res <- getCrossAssociation(
    tse, tse, assay.type1 = "relabundance", assay.type2 = "relabundance", col.var2 = index,
    test.signif = TRUE, mode = "matrix")



# Function for marking significant correlations with "X"
add_signif <- function(j, i, x, y, width, height, fill) {
    # If the p-value is under threshold
    if(significant_rows$pval[i, j] < 0.05 ){
        # Print "X"
        grid.shadowtext(
            sprintf("%s", "*"), x, y, gp = gpar(fontsize = 8, col = "#f5f5f5"))
    }
}

significant_rows <- list()
# Filtrar las filas donde al menos un valor en res$pval es menor a 0.05
significant_rows$cor <- res$cor[apply(res$p_adj < 0.05, 1, any), ]
significant_rows$pval <- res$pval[apply(res$pval < 0.05, 1, any), ]
significant_rows$pval <- significant_rows$pval[rownames(significant_rows$cor), , drop = FALSE]


df2_filtered <- rowData(tse) %>% as.data.frame() 

df2_filtered <- df2_filtered[rownames(significant_rows$cor), , drop = FALSE]  # Mantiene la estructura de dataframe

# Obtener el último nombre presente en cada fila junto con su categoría
result <- t(apply(df2_filtered, 1, function(x) {
  non_empty <- which(x != "")  # Índices de columnas con valores no vacíos
  if (length(non_empty) > 0) {
    last_index <- tail(non_empty, 1)  # Último índice con valor no vacío
    last_name <- x[last_index]  # Último nombre taxonómico encontrado
    last_category <- colnames(df2_filtered)[last_index]  # Nombre de la columna

    # Si el último nivel es "Species", concatenarlo con el "Genus"
    if (last_category == "Species") {
      genus <- x["Genus"]
      if (genus != "") {
        return(c(name = paste(genus, last_name, sep = "_"), category = last_category))
      }
    }
    
    # Si no es especie, devolver solo el nombre
    return(c(name = last_name, category = last_category))
  } else {
    return(c(name = NA, category = NA))  # En caso de fila vacía
  }
}))


rownames(significant_rows$cor) <- result[,1]
colnames(significant_rows$cor) <- c("AR", "HAT", "BC", "No Survival")

```

```{r, fig.width=10, fig.height=10}

library(ComplexHeatmap)
library(shadowtext)
# Create a heatmap
p <- Heatmap(significant_rows$cor,
    cell_fun = add_signif,
    clustering_distance_col = "pearson",
    col = rev(paletteer_c("ggthemes::Red-Blue Diverging", 30)),
    column_km = 3,
    column_names_side = "top", 
    column_dend_side = "bottom",
    column_title = NULL,
    column_names_rot = -90,
    width = unit(5, "cm"),
    rect_gp = gpar(col = "white", lwd = 0.5),
    heatmap_legend_param = list(
        title = "Correlation", legend_width = unit(5, "cm"), direction = "horizontal"),
    ) +
    rowAnnotation(
        Taxa = result[,2],
        col = list(Taxa = c("Species" = "#20B2AA", "Genus" = "mediumpurple1", "Family" = "#EEE685"))
        ) +
    rowAnnotation(names = anno_text(
        rownames(significant_rows$cor), 
        gp = gpar(fontsize = 8),
        rot=-40
        )
    )
    
    

draw(p,merge_legend = TRUE, heatmap_legend_side = "bottom",annotation_legend_side = "bottom")
```

## Profundidad de lectura

```{r}
otu <- assay(tse_lp)
reads_per_sample <- colSums(otu)
singletons       <- colSums(otu == 1)
goods_coverage   <- 1 - singletons / reads_per_sample

qc <- tibble(Sample = names(reads_per_sample),
             Reads  = reads_per_sample,
             Goods  = goods_coverage)

p1 <- ggplot(qc, aes(x = Reads)) +
    geom_histogram(bins = 10, fill = "#98F5FF", colour = "black", alpha = 0.8) +
    geom_vline(xintercept = 5e3, linetype = "dashed", colour = "#BA2F2A") +
    annotate(geom = "text", x = -5e3, y = 15, color = "#BA2F2A", fontface = "bold",
             label = "Minimun threshold in Non complex matrices\nKachroo, et al. Nat Rev Urol. 2021", 
             angle = 90, size =4) +
    labs(title = NULL,
         x = "Read depth",
         y = "Frequency")+ 
    theme_minimal()

p2 <- ggplot(qc, aes(x = Reads, y = Goods)) +
    geom_point(size = 4, alpha = 0.8, 
               fill = "#98F5FF", color = "black", shape = 21) +
    geom_hline(yintercept = 0.95, linetype = "dashed", colour = "#BA2F2A") +
    annotate(geom = "text", x = 60e3, y = 0.85, color = "#BA2F2A", fontface = "bold",
             label = "Threshold in coverage confidence\nYen, et al. BMC Microbiology 2013", 
             size =4) +
    labs(title = NULL,
        x = "Read depth",
        y = "Good's Coverage") +
    theme_minimal() +
    ylim(c(0,1))

rarecurve_data <- rarecurve(t(otu), step=100, col="blue", label=T, cex=0.6) 
p3 <- map_dfr(rarecurve_data, bind_rows) %>% 
    bind_cols(sample = rownames(t(otu)),.) %>% 
    pivot_longer(-sample) %>% 
    drop_na() %>% 
    mutate(n_seqs = as.numeric(str_replace(name, "N", ""))) %>% 
    dplyr::select(-name) %>% 
    ggplot(aes(x = n_seqs, y = value, group = sample)) + 
    geom_line(size = 2, color = "#98F5FF", alpha = 0.8) + 
    geom_vline(xintercept = 5e3, linetype = "dashed", colour = "#BA2F2A") +
    annotate(geom = "text", x = 14e3, y = 200, color = "#BA2F2A", fontface = "bold",
             label = "Minimun threshold in non complex matrices\nKachroo, et al. Nat Rev Urol. 2021", 
             angle = 90, size =4) +
    theme_minimal()+ 
    labs(x= "Read depth", y = "Observed species") +
    theme_minimal()
```

```{r, fig.width=10, fig.height=5}
cowplot::plot_grid(p1, p2, p3, ncol = 3)
```


```{r}

library(tidyverse)
library(phyloseq)
library(microbiome)   # extras: rarefaction curvas

otu_stool  <- assay(tse_stool)
otu_liver  <- assay(tse_higado_sra)
otu_bile   <- assay(tse_bilis_sra2)
otu_fluid  <- assay(tse_lp)

ps_list <- list(
  #Stool  = otu_stool,
  Liver  = otu_liver,
  Bile   = otu_bile,
  OPS  = otu_fluid
)


qc_df <- imap_dfr(ps_list, function(mat, src){
  reads   <- colSums(mat)
  single  <- colSums(mat == 1)
  tibble(
    Sample = names(reads),
    Reads  = reads,
    Goods  = 1 - single / reads,
    Source = src
  )
})

library(ggplot2)

## 5a Histograma por tipo
ggplot(qc_df, aes(Reads, fill = Source)) +
  geom_histogram(bins = 30, alpha = 0.7, position = "identity") +
  geom_vline(xintercept = 5000, linetype = "dashed") +
  facet_wrap(~Source, scales = "free_y")

## 5b Good's coverage vs lecturas
ggplot(qc_df, aes(Reads, Goods, colour = Source)) +
  geom_point() +
  geom_hline(yintercept = 0.95, linetype = "dashed")


## 5d Curvas de rarefacción promedio por Source
depths <- seq(1000, 11000, 1000)

rarecurve_df <- imap_dfr(ps_list, function(mat, src){
  map_dfr(colnames(mat), function(samp){
    counts <- mat[, samp]
    obs <- sapply(depths, function(d){
      if(sum(counts) < d) NA
      else vegan::rarefy(counts, sample = d)
    })
    tibble(Sample = samp,
           Depth   = depths,
           Observed = obs,
           Source  = src)
  })
})

# GRAFICAR
library(ggplot2)
ggplot(rarecurve_df, aes(Depth, Observed, group = Sample, colour = Source)) +
  geom_line(alpha = 0.3) +
  labs(x = "Lecturas subsampleadas",
       y = "OTUs observados",
       title = "Curvas de rarefacción por muestra") +
  theme_minimal()

# ─────────────────────── 6 · Interpretación rápida ──────────────────────
qc_df %>% group_by(Source) %>%
  summarise(min_reads = min(Reads),
            mean_reads = mean(Reads),
            mean_goods = mean(Goods))

```


## Differential Abundance Analysis (DAA)

### MaAsLin2

<https://huttenhower.sph.harvard.edu/maaslin/>

#### Genus

```{r, warning=FALSE, message=FALSE}
# Agglomerate by genus and subset by prevalence
tse_prevalente <- agglomerateByRank(tse_lp, rank = "Genus")
tse_prevalente
```

```{r, eval=FALSE}

variables_salida <- c("Survival", "AR", "AHT", "Biliary_complications")

for (i in variables_salida) {
    
    output_path <- paste0("../../maaslin2/genus/prevalente/paper/", i, "/")
    dir.create(output_path, recursive = TRUE, showWarnings = FALSE)
    
    fit_data2 <- Maaslin2(
        input_data = as.data.frame(t(assay(tse_prevalente))), 
        input_metadata = as.data.frame(colData(tse_prevalente)), 
        output = output_path, 
        fixed_effects = c("Batch", i), 
        reference = c(paste0("Batch,", "RUN 3"), paste0(i, ",", ifelse(i == "Survival", "YES", "NO"))), 
        cores = 4)
    
}


```


```{r}
dda_maaslin_prevalente <- list()

variables_salida <- c("Survival", "AR", "AHT", "Biliary_complications")

for (i in variables_salida) {

    maslin_objeto <- read_delim(paste0("../../maaslin2/genus/prevalente/paper/", i, "/all_results.tsv")) %>%
    dplyr::filter(value != "RUN 1" , value != "RUN 2")

    dda_maaslin_prevalente[[i]] <- maslin_objeto

}


```

```{r, fig.width=10, fig.height=7, warning=FALSE}
do.call(grid.arrange, c(volcanos_maaslin_flr(dda_maaslin_prevalente), ncol= 2))
```

```{r, fig.width=14, fig.height=3.5}
plot_a <- volcanos_maaslin_flr(dda_maaslin_prevalente)$Survival +
    theme(
        legend.position = "none"
    ) +
    labs(
        title = "Survival"
    )
plot_b <- volcanos_maaslin_flr(dda_maaslin_prevalente)$AR +
    theme(
        legend.position = "none"
    ) +
    labs(
        title = "Acute rejection",
        y = ""
    )
plot_c <- volcanos_maaslin_flr(dda_maaslin_prevalente)$AHT +
    theme(
        legend.position = "none"
    )+
    labs(
        title = "Hepatic arterial thrombosis",
        y = ""
    )
plot_d <- volcanos_maaslin_flr(dda_maaslin_prevalente)$Biliary_complications +
    theme(
        legend.position = "right"
    )+
    labs(
        title = "Biliary complications",
        y = ""
    )


cowplot::plot_grid(plot_a, plot_b, plot_c, plot_d, ncol = 4, 
                   rel_widths = c(1, 1, 1, 1.5))
```
```{r}
taxa_relevante_maaslin_especie <- data.frame()

for (i in names(dda_maaslin_prevalente)) {
        
    i_filtrado <- dda_maaslin_prevalente[[i]] %>%
        dplyr::filter(pval < 0.05) %>%
        dplyr::select(feature, coef, stderr, pval, qval)
    
    i_filtrado$variable <- i
    
    i_filtrado$prevalencia <- "prevalente"
    
    for (j in 1:nrow(i_filtrado)) {
        
        if (i_filtrado[j, "coef"] > 0) {
            
            i_filtrado[j, "biosis"] <- "Hiperbiosis"
            
        } else {
            
            i_filtrado[j, "biosis"] <- "Hipobiosis"
            
        }
        
    }
    
    if (nrow(taxa_relevante_maaslin_especie) == 0){
            
        taxa_relevante_maaslin_especie <- i_filtrado
        
    } else {
        
        taxa_relevante_maaslin_especie <- rbind(taxa_relevante_maaslin_especie, i_filtrado)
        
    }
    
    dda_maaslin_prevalente[["taxa_relevante"]] <- taxa_relevante_maaslin_especie
    
}

```


```{r, fig.width=12, fig.height=12}
plots <- list()
variables_salida <- c("Survival", "AR", "AHT", "Biliary_complications")

for (i in variables_salida) {
    features <- taxa_relevante_maaslin_especie |> 
        dplyr::filter(variable == i) |>
        pull(feature)

    df <- agglomerateByRank(tse_lp, "Genus") |>
        transformAssay(assay.type = "counts", method = "relabundance") |>
        assay("relabundance") |> 
        as.data.frame() |>
        rownames_to_column(var = "code") |>
        dplyr::filter(code %in% features) |> 
        pivot_longer(-code, names_to = "sample")
    
    metadata <- colData(tse_lp) |> as.data.frame() |> rownames_to_column("sample")
    
    p <- dplyr::inner_join(df, metadata, by = "sample") |> 
        dplyr::select(code, sample, value, i) |>
        ggplot(aes_string(i, "value", fill= i)) +
        #geom_violin(fill = "gray", alpha= 0.2) +
        stat_compare_means(
            label = "p.signif", 
            ref.group = ifelse(i == "Survival", "YES", "NO")
        ) +
        geom_boxplot(width=0.2) +
        geom_jitter(aes_string(i, "value", fill= i), size = 2) +
        scale_fill_manual(aes_string(x=j, y = i), values = c("#87CEFA", "#FA8072")) +
        guides(fill = "none")+
        theme_minimal()+ 
        labs(y = "Centered log ratio") +
        theme(
            strip.text = element_text(face = "bold", size = 10), # Títulos en negrita y más grandes
            strip.background = element_blank(), # Elimina el fondo del título
        ) +
        
        facet_wrap(~code, scales = "free_y")
    
    plots[[i]] <- p
        
}

plots$Survival
plots$AR
plots$AHT
plots$Biliary_complications


```

```{r, fig.width=12, fig.height=12}
plots <- list()
variables_salida <- c("Survival", "AR", "AHT", "Biliary_complications")

for (i in variables_salida) {
    features <- dda_maaslin_prevalente$taxa_relevante |> 
        dplyr::filter(variable == i) |>
        dplyr::filter(qval <= 0.05) |>
        pull(feature)

    df <- agglomerateByRank(tse_lp, "Genus") |>
        transformAssay(assay.type = "counts", method = "relabundance") |>
        assay("relabundance") |> 
        as.data.frame() |>
        rownames_to_column(var = "code") |>
        dplyr::filter(code %in% features) |> 
        pivot_longer(-code, names_to = "sample")
    
    metadata <- colData(tse_lp) |> as.data.frame() |> rownames_to_column("sample")
    
    p <- dplyr::inner_join(df, metadata, by = "sample") |> 
        dplyr::select(code, sample, value, i) |>
        ggplot(aes_string(i, "value", fill= i)) +
        # geom_violin(fill = "gray", alpha= 0.2) +
        stat_compare_means(
            label = "p.signif", 
            ref.group = ifelse(i == "Survival", "YES", "NO")
        ) +
        geom_boxplot(width=1) +
        geom_jitter(aes_string(i, "value", fill= i), size = 2) +
        scale_fill_manual(aes_string(x=i, y = i), values = c("#87CEFA", "#FA8072")) +
        guides(fill = "none")+
        theme_minimal()+ 
        labs(y = "Centered log ratio") +
        theme(
            strip.text = element_text(face = "bold", size = 10), # Títulos en negrita y más grandes
            strip.background = element_blank(), # Elimina el fondo del título
        ) +
        
        facet_wrap(~code, scales = "free_y") 
    
    plots[[i]] <- p
        
}

plots$Survival
plots$AR
plots$AHT
plots$Biliary_complications


```

```{r}
dda_maaslin_genus <- dda_maaslin_prevalente
```

#### Family

```{r, warning=FALSE, message=FALSE}
# Agglomerate by genus and subset by prevalence
tse_prevalente <- agglomerateByRank(tse_lp, rank = "Family")
tse_prevalente
```

```{r, eval=FALSE}

variables_salida <- c("Survival", "AR", "AHT", "Biliary_complications")

for (i in variables_salida) {
    
    output_path <- paste0("../../maaslin2/family/prevalente/paper/", i, "/")
    dir.create(output_path, recursive = TRUE, showWarnings = FALSE)
    
    fit_data2 <- Maaslin2(
        input_data = as.data.frame(t(assay(tse_prevalente))), 
        input_metadata = as.data.frame(colData(tse_prevalente)), 
        output = output_path, 
        fixed_effects = c("Batch", i), 
        reference = c(paste0("Batch,", "RUN 3"), paste0(i, ",", ifelse(i == "Survival", "YES", "NO"))), 
        cores = 4)
    
}


```


```{r}
dda_maaslin_prevalente <- list()

variables_salida <- c("Survival", "AR", "AHT", "Biliary_complications")

for (i in variables_salida) {

    maslin_objeto <- read_delim(paste0("../../maaslin2/family/prevalente/paper/", i, "/all_results.tsv")) %>%
    dplyr::filter(value != "RUN 1" , value != "RUN 2")

    dda_maaslin_prevalente[[i]] <- maslin_objeto

}

```

```{r, fig.width=14, fig.height=3.5}
plot_a <- volcanos_maaslin_flr(dda_maaslin_prevalente)$Survival +
    theme(
        legend.position = "none"
    ) +
    labs(
        title = "Survival"
    )
plot_b <- volcanos_maaslin_flr(dda_maaslin_prevalente)$AR +
    theme(
        legend.position = "none"
    ) +
    labs(
        title = "Acute rejection",
        y = ""
    )
plot_c <- volcanos_maaslin_flr(dda_maaslin_prevalente)$AHT +
    theme(
        legend.position = "none"
    )+
    labs(
        title = "Hepatic arterial thrombosis",
        y = ""
    )
plot_d <- volcanos_maaslin_flr(dda_maaslin_prevalente)$Biliary_complications +
    theme(
        legend.position = "right"
    )+
    labs(
        title = "Biliary complications",
        y = ""
    )


cowplot::plot_grid(plot_a, plot_b, plot_c, plot_d, ncol = 4, 
                   rel_widths = c(1, 1, 1, 1.5))
```

```{r}
taxa_relevante_maaslin_especie <- data.frame()

for (i in names(dda_maaslin_prevalente)) {
        
    i_filtrado <- dda_maaslin_prevalente[[i]] %>%
        dplyr::filter(pval < 0.05) %>%
        dplyr::select(feature, coef, stderr, pval, qval)
    
    i_filtrado$variable <- i
    
    i_filtrado$prevalencia <- "prevalente"
    
    for (j in 1:nrow(i_filtrado)) {
        
        if (i_filtrado[j, "coef"] > 0) {
            
            i_filtrado[j, "biosis"] <- "Hiperbiosis"
            
        } else {
            
            i_filtrado[j, "biosis"] <- "Hipobiosis"
            
        }
        
    }
    
    if (nrow(taxa_relevante_maaslin_especie) == 0){
            
        taxa_relevante_maaslin_especie <- i_filtrado
        
    } else {
        
        taxa_relevante_maaslin_especie <- rbind(taxa_relevante_maaslin_especie, i_filtrado)
        
    }
    
    dda_maaslin_prevalente[["taxa_relevante"]] <- taxa_relevante_maaslin_especie
    
}

```


```{r, fig.width=12, fig.height=12}
plots <- list()
variables_salida <- c("Survival", "AR", "AHT", "Biliary_complications")

for (i in variables_salida) {
    features <- taxa_relevante_maaslin_especie |> 
        dplyr::filter(variable == i) |>
        pull(feature)

    df <- agglomerateByRank(tse_lp, "Family") |>
        transformAssay(assay.type = "counts", method = "relabundance") |>
        assay("relabundance") |> 
        as.data.frame() |>
        rownames_to_column(var = "code") |>
        dplyr::filter(code %in% features) |> 
        pivot_longer(-code, names_to = "sample")
    
    metadata <- colData(tse_lp) |> as.data.frame() |> rownames_to_column("sample")
    
    p <- dplyr::inner_join(df, metadata, by = "sample") |> 
        dplyr::select(code, sample, value, i) |>
        ggplot(aes_string(i, "value", fill= i)) +
        geom_violin(fill = "gray", alpha= 0.2) +
        stat_compare_means(
            label = "p.signif", 
            ref.group = ifelse(i == "Survival", "YES", "NO")
        ) +
        geom_boxplot(width=0.2) +
        geom_jitter(aes_string(i, "value", fill= i), size = 2) +
        scale_fill_manual(aes_string(x=j, y = i), values = c("#87CEFA", "#FA8072")) +
        guides(fill = "none")+
        theme_minimal()+ 
        labs(y = "Centered log ratio") +
        theme(
            strip.text = element_text(face = "bold", size = 10), # Títulos en negrita y más grandes
            strip.background = element_blank(), # Elimina el fondo del título
        ) +
        
        facet_wrap(~code, scales = "free_y")
    
    plots[[i]] <- p
        
}

plots$Survival
plots$AR
plots$AHT
plots$Biliary_complications


```

```{r, fig.width=12, fig.height=12}
plots <- list()
variables_salida <- c("Survival", "AR", "AHT", "Biliary_complications")

for (i in variables_salida) {
    features <- dda_maaslin_prevalente$taxa_relevante |> 
        dplyr::filter(variable == i) |>
        dplyr::filter(qval <= 0.05) |>
        pull(feature)

    df <- agglomerateByRank(tse_lp, "Family") |>
        transformAssay(assay.type = "counts", method = "relabundance") |>
        assay("relabundance", prevelance = 0) |> 
        as.data.frame() |>
        rownames_to_column(var = "code") |>
        dplyr::filter(code %in% features) |> 
        pivot_longer(-code, names_to = "sample")
    
    metadata <- colData(tse_lp) |> as.data.frame() |> rownames_to_column("sample")
    
    p <- dplyr::inner_join(df, metadata, by = "sample") |> 
        dplyr::select(code, sample, value, i) |>
        ggplot(aes_string(i, "value", fill= i)) +
        #geom_violin(fill = "gray", alpha= 0.2) +
        stat_compare_means(
            label = "p.signif", 
            ref.group = ifelse(i == "Survival", "YES", "NO")
        ) +
        geom_boxplot(width=0.2) +
        geom_jitter(aes_string(i, "value", fill= i), size = 2) +
        scale_fill_manual(aes_string(x=i, y = i), values = c("#87CEFA", "#FA8072")) +
        guides(fill = "none")+
        theme_minimal()+ 
        labs(y = "Centered log ratio") +
        theme(
            strip.text = element_text(face = "bold", size = 10), # Títulos en negrita y más grandes
            strip.background = element_blank(), # Elimina el fondo del título
        ) +
        
        facet_wrap(~code, scales = "free_y") 
    
    plots[[i]] <- p
        
}

plots$Survival
plots$AR
plots$AHT
plots$Biliary_complications


```

```{r}
dda_maaslin_family <- dda_maaslin_prevalente
```

#### Order

```{r, warning=FALSE, message=FALSE}
# Agglomerate by genus and subset by prevalence
tse_prevalente <- agglomerateByRank(tse_lp, rank = "Order")
tse_prevalente
```

```{r, eval=FALSE}

variables_salida <- c("Survival", "AR", "AHT", "Biliary_complications")

for (i in variables_salida) {
    
    output_path <- paste0("../../maaslin2/order/prevalente/paper/", i, "/")
    dir.create(output_path, recursive = TRUE, showWarnings = FALSE)
    
    fit_data2 <- Maaslin2(
        input_data = as.data.frame(t(assay(tse_prevalente))), 
        input_metadata = as.data.frame(colData(tse_prevalente)), 
        output = output_path, 
        fixed_effects = c("Batch", i), 
        reference = c(paste0("Batch,", "RUN 3"), paste0(i, ",", ifelse(i == "Survival", "YES", "NO"))), 
        cores = 4)
    
}
```


```{r}
dda_maaslin_prevalente <- list()

variables_salida <- c("Survival", "AR", "AHT", "Biliary_complications")

for (i in variables_salida) {

    maslin_objeto <- read_delim(paste0("../../maaslin2/order/prevalente/paper/", i, "/all_results.tsv")) %>%
    dplyr::filter(value != "RUN 1" , value != "RUN 2")

    dda_maaslin_prevalente[[i]] <- maslin_objeto

}
```

```{r, fig.width=14, fig.height=3.5}
plot_a <- volcanos_maaslin_flr(dda_maaslin_prevalente)$Survival +
    theme(
        legend.position = "none"
    ) +
    labs(
        title = "Survival"
    )
plot_b <- volcanos_maaslin_flr(dda_maaslin_prevalente)$AR +
    theme(
        legend.position = "none"
    ) +
    labs(
        title = "Acute rejection",
        y = ""
    )
plot_c <- volcanos_maaslin_flr(dda_maaslin_prevalente)$AHT +
    theme(
        legend.position = "none"
    )+
    labs(
        title = "Hepatic arterial thrombosis",
        y = ""
    )
plot_d <- volcanos_maaslin_flr(dda_maaslin_prevalente)$Biliary_complications +
    theme(
        legend.position = "right"
    )+
    labs(
        title = "Biliary complications",
        y = ""
    )


cowplot::plot_grid(plot_a, plot_b, plot_c, plot_d, ncol = 4, 
                   rel_widths = c(1, 1, 1, 1.5))
```

```{r}
taxa_relevante_maaslin_especie <- data.frame()

for (i in names(dda_maaslin_prevalente)) {
        
    i_filtrado <- dda_maaslin_prevalente[[i]] %>%
        dplyr::filter(pval < 0.05) %>%
        dplyr::select(feature, coef, stderr, pval, qval)
    
    i_filtrado$variable <- i
    
    i_filtrado$prevalencia <- "prevalente"
    
    for (j in 1:nrow(i_filtrado)) {
        
        if (i_filtrado[j, "coef"] > 0) {
            
            i_filtrado[j, "biosis"] <- "Hiperbiosis"
            
        } else {
            
            i_filtrado[j, "biosis"] <- "Hipobiosis"
            
        }
        
    }
    
    if (nrow(taxa_relevante_maaslin_especie) == 0){
            
        taxa_relevante_maaslin_especie <- i_filtrado
        
    } else {
        
        taxa_relevante_maaslin_especie <- rbind(taxa_relevante_maaslin_especie, i_filtrado)
        
    }
    
    dda_maaslin_prevalente[["taxa_relevante"]] <- taxa_relevante_maaslin_especie
    
}

```


```{r, fig.width=12, fig.height=12}
plots <- list()
variables_salida <- c("Survival", "AR", "AHT", "Biliary_complications")

for (i in variables_salida) {
    features <- taxa_relevante_maaslin_especie |> 
        dplyr::filter(variable == i) |>
        pull(feature)

    df <- agglomerateByRank(tse_lp, "Order") |>
        transformAssay(assay.type = "counts", method = "relabundance") |>
        assay("relabundance") |> 
        as.data.frame() |>
        rownames_to_column(var = "code") |>
        dplyr::filter(code %in% features) |> 
        pivot_longer(-code, names_to = "sample")
    
    metadata <- colData(tse_lp) |> as.data.frame() |> rownames_to_column("sample")
    
    p <- dplyr::inner_join(df, metadata, by = "sample") |> 
        dplyr::select(code, sample, value, i) |>
        ggplot(aes_string(i, "value", fill= i)) +
        geom_violin(fill = "gray", alpha= 0.2) +
        stat_compare_means(
            label = "p.signif", 
            ref.group = ifelse(i == "Survival", "YES", "NO")
        ) +
        geom_boxplot(width=0.2) +
        geom_jitter(aes_string(i, "value", fill= i), size = 2) +
        scale_fill_manual(aes_string(x=j, y = i), values = c("#87CEFA", "#FA8072")) +
        guides(fill = "none")+
        theme_minimal()+ 
        labs(y = "Centered log ratio") +
        theme(
            strip.text = element_text(face = "bold", size = 10), # Títulos en negrita y más grandes
            strip.background = element_blank(), # Elimina el fondo del título
        ) +
        
        facet_wrap(~code, scales = "free_y")
    
    plots[[i]] <- p
        
}

plots$Survival
plots$AR
plots$AHT
plots$Biliary_complications


```


```{r}
dda_maaslin_order <- dda_maaslin_prevalente
```


#### Class

```{r, warning=FALSE, message=FALSE}
# Agglomerate by genus and subset by prevalence
tse_prevalente <- agglomerateByRank(tse_lp, rank = "Class")
tse_prevalente
```

```{r, eval=FALSE}

variables_salida <- c("Survival", "AR", "AHT", "Biliary_complications")

for (i in variables_salida) {
    
    output_path <- paste0("../../maaslin2/class/prevalente/paper/", i, "/")
    dir.create(output_path, recursive = TRUE, showWarnings = FALSE)
    
    fit_data2 <- Maaslin2(
        input_data = as.data.frame(t(assay(tse_prevalente))), 
        input_metadata = as.data.frame(colData(tse_prevalente)), 
        output = output_path, 
        fixed_effects = c("Batch", i), 
        reference = c(paste0("Batch,", "RUN 3"), paste0(i, ",", ifelse(i == "Survival", "YES", "NO"))), 
        cores = 4)
    
}

```


```{r}
dda_maaslin_prevalente <- list()

variables_salida <- c("Survival", "AR", "AHT", "Biliary_complications")

for (i in variables_salida) {

    maslin_objeto <- read_delim(paste0("../../maaslin2/class/prevalente/paper/", i, "/all_results.tsv")) %>%
    dplyr::filter(value != "RUN 1" , value != "RUN 2")

    dda_maaslin_prevalente[[i]] <- maslin_objeto

}
```

```{r, fig.width=14, fig.height=3.5}
plot_a <- volcanos_maaslin_flr(dda_maaslin_prevalente)$Survival +
    theme(
        legend.position = "none"
    ) +
    labs(
        title = "Survival"
    )
plot_b <- volcanos_maaslin_flr(dda_maaslin_prevalente)$AR +
    theme(
        legend.position = "none"
    ) +
    labs(
        title = "Acute rejection",
        y = ""
    )
plot_c <- volcanos_maaslin_flr(dda_maaslin_prevalente)$AHT +
    theme(
        legend.position = "none"
    )+
    labs(
        title = "Hepatic arterial thrombosis",
        y = ""
    )
plot_d <- volcanos_maaslin_flr(dda_maaslin_prevalente)$Biliary_complications +
    theme(
        legend.position = "right"
    )+
    labs(
        title = "Biliary complications",
        y = ""
    )


cowplot::plot_grid(plot_a, plot_b, plot_c, plot_d, ncol = 4, 
                   rel_widths = c(1, 1, 1, 1.5))
```

```{r}
taxa_relevante_maaslin_especie <- data.frame()

for (i in names(dda_maaslin_prevalente)) {
        
    i_filtrado <- dda_maaslin_prevalente[[i]] %>%
        dplyr::filter(pval < 0.05) %>%
        dplyr::select(feature, coef, stderr, pval, qval)
    if (nrow(i_filtrado) == 0){ next }
    
    i_filtrado$variable <- i
    
    i_filtrado$prevalencia <- "prevalente"
    
    for (j in 1:nrow(i_filtrado)) {
        
        if (i_filtrado[j, "coef"] > 0) {
            
            i_filtrado[j, "biosis"] <- "Hiperbiosis"
            
        } else {
            
            i_filtrado[j, "biosis"] <- "Hipobiosis"
            
        }
        
    }
    
    if (nrow(taxa_relevante_maaslin_especie) == 0){
            
        taxa_relevante_maaslin_especie <- i_filtrado
        
    } else {
        
        taxa_relevante_maaslin_especie <- rbind(taxa_relevante_maaslin_especie, i_filtrado)
        
    }
    
    dda_maaslin_prevalente[["taxa_relevante"]] <- taxa_relevante_maaslin_especie
    
}

```


```{r, fig.width=12, fig.height=12}
plots <- list()
variables_salida <- c("Survival", "AR", "AHT", "Biliary_complications")

for (i in variables_salida) {
    features <- taxa_relevante_maaslin_especie |> 
        dplyr::filter(variable == i) |>
        pull(feature)
    
    if (length(features) == 0){ next }

    df <- agglomerateByRank(tse_lp, "Class") |>
        assay("relabundance") |> 
        as.data.frame() |>
        rownames_to_column(var = "code") |>
        dplyr::filter(code %in% features) |> 
        pivot_longer(-code, names_to = "sample")
    
    metadata <- colData(tse_lp) |> as.data.frame() |> rownames_to_column("sample")
    
    p <- dplyr::inner_join(df, metadata, by = "sample") |> 
        dplyr::select(code, sample, value, i) |>
        ggplot(aes_string(i, "value", fill= i)) +
        # geom_violin(fill = "gray", alpha= 0.2) +
        stat_compare_means(
            label = "p.signif", 
            ref.group = ifelse(i == "Survival", "YES", "NO")
        ) +
        geom_boxplot(width=0.2) +
        geom_jitter(aes_string(i, "value", fill= i), size = 2) +
        scale_fill_manual(aes_string(x=j, y = i), values = c("#87CEFA", "#FA8072")) +
        guides(fill = "none")+
        theme_minimal()+ 
        labs(y = "Centered log ratio") +
        theme(
            strip.text = element_text(face = "bold", size = 10), # Títulos en negrita y más grandes
            strip.background = element_blank(), # Elimina el fondo del título
        ) +
        
        facet_wrap(~code, scales = "free_y")
    
    plots[[i]] <- p
        
}

plots$Survival
plots$AR
plots$AHT
plots$Biliary_complications


```

```{r}
dda_maaslin_class <- dda_maaslin_prevalente
```


#### Phylum

```{r, warning=FALSE, message=FALSE}
# Agglomerate by genus and subset by prevalence
tse_prevalente <- agglomerateByRank(tse_lp, rank = "Phylum")
tse_prevalente
```

```{r, eval=FALSE}

variables_salida <- c("Survival", "AR", "AHT", "Biliary_complications")

for (i in variables_salida) {
    
    output_path <- paste0("../../maaslin2/phylum/prevalente/paper/", i, "/")
    dir.create(output_path, recursive = TRUE, showWarnings = FALSE)
    
    fit_data2 <- Maaslin2(
        input_data = as.data.frame(t(assay(tse_prevalente))), 
        input_metadata = as.data.frame(colData(tse_prevalente)), 
        output = output_path, 
        fixed_effects = c("Batch", i), 
        reference = c(paste0("Batch,", "RUN 3"), paste0(i, ",", ifelse(i == "Survival", "YES", "NO"))), 
        cores = 4)
    
}

dda_maaslin_phylum <- dda_maaslin_prevalente
```


```{r}
dda_maaslin_prevalente <- list()

variables_salida <- c("Survival", "AR", "AHT", "Biliary_complications")

for (i in variables_salida) {

    maslin_objeto <- read_delim(paste0("../../maaslin2/phylum/prevalente/paper/", i, "/all_results.tsv")) %>%
    dplyr::filter(value != "RUN 1" , value != "RUN 2")

    dda_maaslin_prevalente[[i]] <- maslin_objeto

}
```

```{r, fig.width=14, fig.height=3.5}
plot_a <- volcanos_maaslin_flr(dda_maaslin_prevalente)$Survival +
    theme(
        legend.position = "none"
    ) +
    labs(
        title = "Survival"
    )
plot_b <- volcanos_maaslin_flr(dda_maaslin_prevalente)$AR +
    theme(
        legend.position = "none"
    ) +
    labs(
        title = "Acute rejection",
        y = ""
    )
plot_c <- volcanos_maaslin_flr(dda_maaslin_prevalente)$AHT +
    theme(
        legend.position = "none"
    )+
    labs(
        title = "Hepatic arterial thrombosis",
        y = ""
    )
plot_d <- volcanos_maaslin_flr(dda_maaslin_prevalente)$Biliary_complications +
    theme(
        legend.position = "right"
    )+
    labs(
        title = "Biliary complications",
        y = ""
    )


cowplot::plot_grid(plot_a, plot_b, plot_c, plot_d, ncol = 4, 
                   rel_widths = c(1, 1, 1, 1.5))
```

```{r}
taxa_relevante_maaslin_especie <- data.frame()

for (i in names(dda_maaslin_prevalente)) {
        
    i_filtrado <- dda_maaslin_prevalente[[i]] %>%
        dplyr::filter(pval < 0.05) %>%
        dplyr::select(feature, coef, stderr, pval, qval)
    if (nrow(i_filtrado) == 0){ next }
    
    i_filtrado$variable <- i
    
    i_filtrado$prevalencia <- "prevalente"
    
    for (j in 1:nrow(i_filtrado)) {
        
        if (i_filtrado[j, "coef"] > 0) {
            
            i_filtrado[j, "biosis"] <- "Hiperbiosis"
            
        } else {
            
            i_filtrado[j, "biosis"] <- "Hipobiosis"
            
        }
        
    }
    
    if (nrow(taxa_relevante_maaslin_especie) == 0){
            
        taxa_relevante_maaslin_especie <- i_filtrado
        
    } else {
        
        taxa_relevante_maaslin_especie <- rbind(taxa_relevante_maaslin_especie, i_filtrado)
        
    }
    
    dda_maaslin_prevalente[["taxa_relevante"]] <- taxa_relevante_maaslin_especie
    
}

```


```{r, fig.width=12, fig.height=12}
plots <- list()
variables_salida <- c("Survival", "AR", "AHT", "Biliary_complications")

for (i in variables_salida) {
    features <- taxa_relevante_maaslin_especie |> 
        dplyr::filter(variable == i) |>
        pull(feature)
    
    if (length(features) == 0){ next }

    df <- agglomerateByRank(tse_lp, "Phylum") |>
        assay("relabundance") |> 
        as.data.frame() |>
        rownames_to_column(var = "code") |>
        dplyr::filter(code %in% features) |> 
        pivot_longer(-code, names_to = "sample")
    
    metadata <- colData(tse_lp) |> as.data.frame() |> rownames_to_column("sample")
    
    p <- dplyr::inner_join(df, metadata, by = "sample") |> 
        dplyr::select(code, sample, value, i) |>
        ggplot(aes_string(i, "value", fill= i)) +
        # geom_violin(fill = "gray", alpha= 0.2) +
        stat_compare_means(
            label = "p.signif", 
            ref.group = ifelse(i == "Survival", "YES", "NO")
        ) +
        geom_boxplot(width=0.2) +
        geom_jitter(aes_string(i, "value", fill= i), size = 2) +
        scale_fill_manual(aes_string(x=j, y = i), values = c("#87CEFA", "#FA8072")) +
        guides(fill = "none")+
        theme_minimal()+ 
        labs(y = "Centered log ratio") +
        theme(
            strip.text = element_text(face = "bold", size = 10), # Títulos en negrita y más grandes
            strip.background = element_blank(), # Elimina el fondo del título
        ) +
        
        facet_wrap(~code, scales = "free_y")
    
    plots[[i]] <- p
        
}

plots$Survival
plots$AR
plots$AHT
plots$Biliary_complications


```

```{r}

dda_maaslin_phylum <- dda_maaslin_prevalente
```


# Articulo 

```{r, fig.width=10}
plotear_abundancia_relativa(abundancias_phylum, "Phylum")
```

```{r, fig.width=10}
plotear_abundancia_relativa(abundancias_class, "Class")
```


```{r, fig.width=12, fig.height=4}
plot_a <- plots_alpha$Survival$shannon_diversity +
    labs(
        title = "Survival",
        x = "", 
        y = "Shannon index"
    ) +
    theme(
        plot.title = element_text(face = "bold", size = 14),
        plot.margin = margin(20,20,20,20)
    )
plot_b <- plots_alpha$AR$shannon_diversity+
    labs(
        title = "Acute Rejection",
        x = "", 
        y = "Shannon index"
    ) +
    theme(
        plot.title = element_text(face = "bold", size = 14),
        plot.margin = margin(20,20,20,20)
    )
plot_c <- plots_alpha$AHT$shannon_diversity+
    labs(
        title = "Hepatic arterial thrombosis",
        x = "", 
        y = "Shannon index"
    ) +
    theme(
        plot.title = element_text(face = "bold", size = 14),
        plot.margin = margin(20,20,20,20)
    )

plot_d <- plots_alpha$Biliary_complications$shannon_diversity +
    labs(
        title = "Biliary complications",
        x = "", 
        y = "Shannon index"
    ) +
    theme(
        plot.title = element_text(face = "bold", size = 14),
        plot.margin = margin(20,20,20,20)
    ) 


cowplot::plot_grid(plot_a, plot_b, plot_c, plot_d, ncol = 4)
```

## Genus

```{r, fig.width=16, fig.height=4}
dda_maaslin_prevalente <- dda_maaslin_genus

plot_a <- volcanos_maaslin_flr(dda_maaslin_prevalente)$Survival +
    theme(
        legend.position = "none",
         plot.title = element_text(face = "bold", size = 14)
    ) +
    labs(
        title = "Survival"
    ) +
    annotate(
        "text", 
        x = 2, 
        y = 0, 
        label = paste0("Hyperabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "Survival" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hiperbiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#FA8072"
    ) +
    annotate(
        "text", 
        x = -2, 
        y = 0, 
        label = paste0("Hypoabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "Survival" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hipobiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#87CEFA"
    ) +
    xlim(c(-3.5, 3.5))

plot_b <- volcanos_maaslin_flr(dda_maaslin_prevalente)$AR +
    theme(
        legend.position = "none",
         plot.title = element_text(face = "bold", size = 14)
    ) +
    labs(
        title = "Acute rejection",
        y = ""
    )+
    annotate(
        "text", 
        x = 2, 
        y = 0, 
        label = paste0("Hyperabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "AR" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hiperbiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#FA8072"
    ) +
    annotate(
        "text", 
        x = -2, 
        y = 0, 
        label = paste0("Hypoabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "AR" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hipobiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#87CEFA"
    ) +
    xlim(c(-3.5, 3.5))

plot_c <- volcanos_maaslin_flr(dda_maaslin_prevalente)$AHT +
    theme(
        legend.position = "none",
         plot.title = element_text(face = "bold", size = 14)
    )+
    labs(
        title = "Hepatic arterial thrombosis",
        y = ""
    )+
    annotate(
        "text", 
        x = 2, 
        y = 0, 
        label = paste0("Hyperabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "AHT" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hiperbiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#FA8072"
    ) +
    annotate(
        "text", 
        x = -2, 
        y = 0, 
        label = paste0("Hypoabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "AHT" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hipobiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#87CEFA"
    ) +
    xlim(c(-3.5, 3.5))

plot_d <- volcanos_maaslin_flr(dda_maaslin_prevalente)$Biliary_complications +
    theme(
        legend.position = "none",
         plot.title = element_text(face = "bold", size = 14)
    )+
    labs(
        title = "Biliary complications",
        y = ""
    ) +
    annotate(
        "text", 
        x = 2, 
        y = 0, 
        label = paste0("Hyperabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "Biliary_complications" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hiperbiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#FA8072"
    ) +
    annotate(
        "text", 
        x = -2, 
        y = 0, 
        label = paste0("Hypoabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "Biliary_complications" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hipobiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#87CEFA"
    ) +
    xlim(c(-3.5, 3.5))


cowplot::plot_grid(plot_a, plot_b, plot_c, plot_d, 
                   ncol = 4)
```

## family

```{r, fig.width=16, fig.height=4}
dda_maaslin_prevalente <- dda_maaslin_family

plot_a <- volcanos_maaslin_flr(dda_maaslin_prevalente)$Survival +
    theme(
        legend.position = "none",
         plot.title = element_text(face = "bold", size = 14)
    ) +
    labs(
        title = "Survival"
    ) +
    annotate(
        "text", 
        x = 2, 
        y = 0, 
        label = paste0("Hyperabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "Survival" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hiperbiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#FA8072"
    ) +
    annotate(
        "text", 
        x = -2, 
        y = 0, 
        label = paste0("Hypoabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "Survival" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hipobiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#87CEFA"
    ) +
    xlim(c(-3.5, 3.5))

plot_b <- volcanos_maaslin_flr(dda_maaslin_prevalente)$AR +
    theme(
        legend.position = "none",
         plot.title = element_text(face = "bold", size = 14)
    ) +
    labs(
        title = "Acute rejection",
        y = ""
    )+
    annotate(
        "text", 
        x = 2, 
        y = 0, 
        label = paste0("Hyperabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "AR" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hiperbiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#FA8072"
    ) +
    annotate(
        "text", 
        x = -2, 
        y = 0, 
        label = paste0("Hypoabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "AR" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hipobiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#87CEFA"
    ) +
    xlim(c(-3.5, 3.5))

plot_c <- volcanos_maaslin_flr(dda_maaslin_prevalente)$AHT +
    theme(
        legend.position = "none",
         plot.title = element_text(face = "bold", size = 14)
    )+
    labs(
        title = "Hepatic arterial thrombosis",
        y = ""
    )+
    annotate(
        "text", 
        x = 2, 
        y = 0, 
        label = paste0("Hyperabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "AHT" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hiperbiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#FA8072"
    ) +
    annotate(
        "text", 
        x = -2, 
        y = 0, 
        label = paste0("Hypoabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "AHT" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hipobiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#87CEFA"
    ) +
    xlim(c(-3.5, 3.5))

plot_d <- volcanos_maaslin_flr(dda_maaslin_prevalente)$Biliary_complications +
    theme(
        legend.position = "none",
         plot.title = element_text(face = "bold", size = 14)
    )+
    labs(
        title = "Biliary complications",
        y = ""
    ) +
    annotate(
        "text", 
        x = 2, 
        y = 0, 
        label = paste0("Hyperabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "Biliary_complications" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hiperbiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#FA8072"
    ) +
    annotate(
        "text", 
        x = -2, 
        y = 0, 
        label = paste0("Hypoabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "Biliary_complications" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hipobiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#87CEFA"
    ) +
    xlim(c(-3.5, 3.5))


cowplot::plot_grid(plot_a, plot_b, plot_c, plot_d, 
                   ncol = 4)
```

## Order

```{r, fig.width=16, fig.height=4}
dda_maaslin_prevalente <- dda_maaslin_order

plot_a <- volcanos_maaslin_flr(dda_maaslin_prevalente)$Survival +
    theme(
        legend.position = "none",
         plot.title = element_text(face = "bold", size = 14)
    ) +
    labs(
        title = "Survival"
    ) +
    annotate(
        "text", 
        x = 2, 
        y = 0, 
        label = paste0("Hyperabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "Survival" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hiperbiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#FA8072"
    ) +
    annotate(
        "text", 
        x = -2, 
        y = 0, 
        label = paste0("Hypoabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "Survival" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hipobiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#87CEFA"
    ) +
    xlim(c(-3.5, 3.5))

plot_b <- volcanos_maaslin_flr(dda_maaslin_prevalente)$AR +
    theme(
        legend.position = "none",
         plot.title = element_text(face = "bold", size = 14)
    ) +
    labs(
        title = "Acute rejection",
        y = ""
    )+
    annotate(
        "text", 
        x = 2, 
        y = 0, 
        label = paste0("Hyperabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "AR" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hiperbiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#FA8072"
    ) +
    annotate(
        "text", 
        x = -2, 
        y = 0, 
        label = paste0("Hypoabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "AR" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hipobiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#87CEFA"
    ) +
    xlim(c(-3.5, 3.5))

plot_c <- volcanos_maaslin_flr(dda_maaslin_prevalente)$AHT +
    theme(
        legend.position = "none",
         plot.title = element_text(face = "bold", size = 14)
    )+
    labs(
        title = "Hepatic arterial thrombosis",
        y = ""
    )+
    annotate(
        "text", 
        x = 2, 
        y = 0, 
        label = paste0("Hyperabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "AHT" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hiperbiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#FA8072"
    ) +
    annotate(
        "text", 
        x = -2, 
        y = 0, 
        label = paste0("Hypoabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "AHT" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hipobiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#87CEFA"
    ) +
    xlim(c(-3.5, 3.5))

plot_d <- volcanos_maaslin_flr(dda_maaslin_prevalente)$Biliary_complications +
    theme(
        legend.position = "none",
         plot.title = element_text(face = "bold", size = 14)
    )+
    labs(
        title = "Biliary complications",
        y = ""
    ) +
    annotate(
        "text", 
        x = 2, 
        y = 0, 
        label = paste0("Hyperabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "Biliary_complications" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hiperbiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#FA8072"
    ) +
    annotate(
        "text", 
        x = -2, 
        y = 0, 
        label = paste0("Hypoabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "Biliary_complications" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hipobiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#87CEFA"
    ) +
    xlim(c(-3.5, 3.5))


cowplot::plot_grid(plot_a, plot_b, plot_c, plot_d, 
                   ncol = 4)
```

## Class

```{r, fig.width=16, fig.height=4}
dda_maaslin_prevalente <- dda_maaslin_class

plot_a <- volcanos_maaslin_flr(dda_maaslin_prevalente)$Survival +
    theme(
        legend.position = "none",
         plot.title = element_text(face = "bold", size = 14)
    ) +
    labs(
        title = "Survival"
    ) +
    annotate(
        "text", 
        x = 2, 
        y = 0, 
        label = paste0("Hyperabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "Survival" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hiperbiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#FA8072"
    ) +
    annotate(
        "text", 
        x = -2, 
        y = 0, 
        label = paste0("Hypoabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "Survival" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hipobiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#87CEFA"
    ) +
    xlim(c(-3.5, 3.5))

plot_b <- volcanos_maaslin_flr(dda_maaslin_prevalente)$AR +
    theme(
        legend.position = "none",
         plot.title = element_text(face = "bold", size = 14)
    ) +
    labs(
        title = "Acute rejection",
        y = ""
    )+
    annotate(
        "text", 
        x = 2, 
        y = 0, 
        label = paste0("Hyperabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "AR" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hiperbiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#FA8072"
    ) +
    annotate(
        "text", 
        x = -2, 
        y = 0, 
        label = paste0("Hypoabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "AR" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hipobiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#87CEFA"
    ) +
    xlim(c(-3.5, 3.5))

plot_c <- volcanos_maaslin_flr(dda_maaslin_prevalente)$AHT +
    theme(
        legend.position = "none",
         plot.title = element_text(face = "bold", size = 14)
    )+
    labs(
        title = "Hepatic arterial thrombosis",
        y = ""
    )+
    annotate(
        "text", 
        x = 2, 
        y = 0, 
        label = paste0("Hyperabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "AHT" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hiperbiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#FA8072"
    ) +
    annotate(
        "text", 
        x = -2, 
        y = 0, 
        label = paste0("Hypoabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "AHT" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hipobiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#87CEFA"
    ) +
    xlim(c(-3.5, 3.5))

plot_d <- volcanos_maaslin_flr(dda_maaslin_prevalente)$Biliary_complications +
    theme(
        legend.position = "none",
         plot.title = element_text(face = "bold", size = 14)
    )+
    labs(
        title = "Biliary complications",
        y = ""
    ) +
    annotate(
        "text", 
        x = 2, 
        y = 0, 
        label = paste0("Hyperabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "Biliary_complications" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hiperbiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#FA8072"
    ) +
    annotate(
        "text", 
        x = -2, 
        y = 0, 
        label = paste0("Hypoabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "Biliary_complications" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hipobiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#87CEFA"
    ) +
    xlim(c(-3.5, 3.5))


cowplot::plot_grid(plot_a, plot_b, plot_c, plot_d, 
                   ncol = 4)
```

## Phylum

```{r, fig.width=16, fig.height=4}
dda_maaslin_prevalente <- dda_maaslin_phylum

plot_a <- volcanos_maaslin_flr(dda_maaslin_prevalente)$Survival +
    theme(
        legend.position = "none",
         plot.title = element_text(face = "bold", size = 14)
    ) +
    labs(
        title = "Survival"
    ) +
    annotate(
        "text", 
        x = 2, 
        y = 0, 
        label = paste0("Hyperabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "Survival" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hiperbiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#FA8072"
    ) +
    annotate(
        "text", 
        x = -2, 
        y = 0, 
        label = paste0("Hypoabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "Survival" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hipobiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#87CEFA"
    ) +
    xlim(c(-3.5, 3.5))

plot_b <- volcanos_maaslin_flr(dda_maaslin_prevalente)$AR +
    theme(
        legend.position = "none",
         plot.title = element_text(face = "bold", size = 14)
    ) +
    labs(
        title = "Acute rejection",
        y = ""
    )+
    annotate(
        "text", 
        x = 2, 
        y = 0, 
        label = paste0("Hyperabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "AR" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hiperbiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#FA8072"
    ) +
    annotate(
        "text", 
        x = -2, 
        y = 0, 
        label = paste0("Hypoabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "AR" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hipobiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#87CEFA"
    ) +
    xlim(c(-3.5, 3.5))

plot_c <- volcanos_maaslin_flr(dda_maaslin_prevalente)$AHT +
    theme(
        legend.position = "none",
         plot.title = element_text(face = "bold", size = 14)
    )+
    labs(
        title = "Hepatic arterial thrombosis",
        y = ""
    )+
    annotate(
        "text", 
        x = 2, 
        y = 0, 
        label = paste0("Hyperabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "AHT" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hiperbiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#FA8072"
    ) +
    annotate(
        "text", 
        x = -2, 
        y = 0, 
        label = paste0("Hypoabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "AHT" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hipobiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#87CEFA"
    ) +
    xlim(c(-3.5, 3.5))

plot_d <- volcanos_maaslin_flr(dda_maaslin_prevalente)$Biliary_complications +
    theme(
        legend.position = "none",
         plot.title = element_text(face = "bold", size = 14)
    )+
    labs(
        title = "Biliary complications",
        y = ""
    ) +
    annotate(
        "text", 
        x = 2, 
        y = 0, 
        label = paste0("Hyperabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "Biliary_complications" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hiperbiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#FA8072"
    ) +
    annotate(
        "text", 
        x = -2, 
        y = 0, 
        label = paste0("Hypoabundant:", nrow(dda_maaslin_prevalente$taxa_relevante[dda_maaslin_prevalente$taxa_relevante$variable == "Biliary_complications" & dda_maaslin_prevalente$taxa_relevante$biosis == "Hipobiosis", ])), 
        size = 4,    # Tamaño del texto
        hjust = 0.5, # Ajusta el texto horizontalmente
        vjust = 0.5, # Ajusta el texto verticalmente
        fontface = "bold", # Configura el texto como no negrita
        color = "#87CEFA"
    ) +
    xlim(c(-3.5, 3.5))


cowplot::plot_grid(plot_a, plot_b, plot_c, plot_d, 
                   ncol = 4)
```

```{r}
library(kableExtra)
library(officer)
library(flextable)

dda_maaslin_prevalente <- dda_maaslin_genus


# Aplicar la función
tabla_resumen <- dda_maaslin_prevalente$taxa_relevante |> 
    mutate(across(where(is.numeric), ~ round(.x, 3))) |>
    mutate(pval = ifelse(pval < 0.001, "<0.001", round(pval, 3)))

tabla_docx <- tabla_resumen %>%
  flextable() %>%
  autofit() %>%
  set_table_properties(layout = "autofit")

# Guardar la tabla como archivo Word
save_as_docx(tabla_docx, path = "../../tabla_maaslin_genus.docx")

```



